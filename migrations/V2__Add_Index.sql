-- Check if the index already exists before creating
DO $$
BEGIN
    EXECUTE 'SET search_path TO cve';
    
    IF NOT EXISTS (
        SELECT 1
        FROM pg_indexes
        WHERE schemaname = 'cve'
        AND tablename = 'CVE'
        AND indexname = 'idx_cve_cve_metadata_gin'
    )
    THEN
        -- Create a GIN index on the cve_metadata JSONB column
        CREATE INDEX IF NOT EXISTS idx_cve_cve_metadata_gin ON cve.CVE USING GIN (cve_metadata);
    END IF;
END $$;

-- Check if the index already exists before creating
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1
        FROM pg_indexes
        WHERE schemaname = 'cve'
        AND tablename = 'CVE'
        AND indexname = 'idx_cve_containers_gin'
    )
    THEN
        -- Create a GIN index on the containers JSONB column
        CREATE INDEX IF NOT EXISTS idx_cve_containers_gin ON cve.CVE USING GIN (containers);
    END IF;
END $$;